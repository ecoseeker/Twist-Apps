/*
----------------------------------------------
 GoMaps v.0.1
 Developed by Ollie Bettany / Twist Internet
 Created: 12/05/10
----------------------------------------------
*/		
		
var marker;var baseIcon=new GIcon(G_DEFAULT_ICON);baseIcon.image="../images/map-marker-orange.png";baseIcon.iconSize=new GSize(34,33);var blueIcon=new GIcon(baseIcon);blueIcon.image="../images/map-marker-blue.png";var yellowIcon=new GIcon(baseIcon);yellowIcon.image="../images/map-marker-yellow.png";var mission_id=0;var i=0;function handleNoFlash(a){if(a==FLASH_UNAVAILABLE){alert("Error: Flash doesn't appear to be supported by your browser");return;}}function initialize(){var map=new GMap2(document.getElementById("map_canvas"));map.setMapType(G_HYBRID_MAP);if(customControls!=true){map.addControl(new GLargeMapControl());map.addControl(new GMapTypeControl());}else{map.addControl(new TextualZoomControl());}map.setCenter(new GLatLng(mapLat,mapLng),mapZoom);if(streetviewEnabled==true){var myPano=new GStreetviewPanorama(document.getElementById("pano"));GEvent.addListener(myPano,"error",handleNoFlash);GEvent.addListener(map,"click",function(overlay,latlng){myPano.setLocationAndPOV(latlng);});}var maptips=new MapTips(map);GEvent.addListener(map,"click",function(overlay,latlng){if(latlng){i++;markerOptions={icon:blueIcon,draggable:true};marker=new GMarker(latlng,markerOptions);var html="<div class='form'><input type='hidden' id='location' value='"+mapLocation+"' /><label for='name'>Name:</label><input type='text' id='name' value='New Marker' /><label for='type'>Content type:</label><select id='type'><option value='1' selected>Text</option><option value='2'>YouTube URL</option></select><label for='markcontent'>Content:</label><input id='markcontent' value='Content here' /><label for='colour'>Colour:</label><select id='colour'><option value='red' selected>Red</option><option value='orange'>Orange</option><option value='green'>Green</option><option value='yellow'>Yellow</option><option value='blue'>Blue</option></select><input type='button' class='submit' value='Save & Close' onclick='saveData()'/><input type='button' class='submit' value='Remove Marker' onclick='removeMarker()'/></div>";map.addOverlay(marker);marker.openInfoWindow(html);GEvent.addListener(marker,"click",function(){marker.openInfoWindow(html);});}});var agents_html="";var gmarkers=[];var htmls=[];var i=0;createMarker=function(point,name,html,colour){var customIcon=new GIcon(baseIcon);customIcon.image="../images/map-marker-"+colour+".png";markerOptions={icon:customIcon,title:name};var marker=new GMarker(point,markerOptions);GEvent.addListener(marker,"click",function(){marker.openInfoWindowHtml(html);if(streetviewEnabled==true){myPano.setLocationAndPOV(point);}});gmarkers[i]=marker;htmls[i]=html;agents_html+='<option value="'+i+'">'+name+"</option>";i++;return marker;};function createPolyline(points,colour,width,name,html){var polyline=new GPolyline(points,colour,width);GEvent.addListener(polyline,"click",function(){displayCustomMessage(html);});GEvent.addListener(polyline,"mouseover",function(){displayCustomMessage(name);});GEvent.addListener(polyline,"mouseout",function(){displayCustomMessage("hide");});return polyline;}$().mousemove(function(e){$("#document").html("e.pageX = "+e.pageX+", e.pageY = "+e.pageY);$("#top").val(e.pageY);$("#left").val(e.pageX);});$("#click").click(function(e){$("#click").html("e.pageX = "+e.pageX+", e.pageY = "+e.pageY);});function displayCustomMessage(html){if(html!="hide"){$("#ollietip").css("top",parseInt($("#top").val())+20);$("#ollietip").css("left",parseInt($("#left").val()));$("#ollietip").html(html);$("#ollietip").show();}else{$("#ollietip").hide();}}myclick=function(i){gmarkers[i].openInfoWindowHtml(htmls[i]);};process_it=function(doc){map.clearOverlays();var jsonData=eval("("+doc+")");for(var i=0;i<jsonData.markers.length;i++){var point=new GLatLng(jsonData.markers[i].lat,jsonData.markers[i].lng);if(jsonData.markers[i].type==1){var html='<div class="bubble"><h3>'+jsonData.markers[i].label+"</h3><p>"+jsonData.markers[i].html+"</p></div>";}if(jsonData.markers[i].type==2){var html="<object width='480' height='385'><param name='movie' value='http://www.youtube.com/v/"+jsonData.markers[i].html+"&hl=en_GB&fs=1&rel=0'></param><param name='allowFullScreen' value='true'></param><param name='allowscriptaccess' value='always'></param><embed src='http://www.youtube.com/v/"+jsonData.markers[i].html+"&hl=en_GB&fs=1&rel=0' type='application/x-shockwave-flash' allowscriptaccess='always' allowfullscreen='true' width='200' height='160'></embed></object>";}var marker=createMarker(point,jsonData.markers[i].label,html,jsonData.markers[i].colour);map.addOverlay(marker);maptips.add_tooltip(marker,jsonData.markers[i].label);}document.getElementById("agent").innerHTML='<option value="0">ALL AGENTS</option>'+agents_html;for(var i=0;i<jsonData.lines.length;i++){var skip_mission=false;if(mission_id!=0){if(jsonData.lines[i].mission_id!=mission_id){skip_mission=true;}}if(skip_mission==false){var points=[];for(var j=0;j<jsonData.lines[i].points.length;j++){points[j]=new GLatLng(jsonData.lines[i].points[j].lat,jsonData.lines[i].points[j].lng);}var html='<div class="bubble"><h3>'+jsonData.lines[i].label+"</h3><p>"+jsonData.lines[i].html+"</p></div>";var polyline=createPolyline(points,jsonData.lines[i].colour,jsonData.lines[i].width,jsonData.lines[i].label,html);map.addOverlay(polyline);}}};saveData=function(){var type=escape(document.getElementById("type").value);var name=escape(document.getElementById("name").value);var content=escape(document.getElementById("markcontent").value);var colour=escape(document.getElementById("colour").value);var location=escape(document.getElementById("location").value);var latlng=marker.getLatLng();var lat=latlng.lat();var lng=latlng.lng();var url="dbconnect.php?insert=true&name="+name+"&content="+content+"&colour="+colour+"&lat="+lat+"&lng="+lng+"&location="+location+"&type="+type;GDownloadUrl(url,function(data,responseCode){if(responseCode==200&&data.length<=1){marker.closeInfoWindow();map.removeOverlay(marker);document.getElementById("message").innerHTML="Location added.";var point=new GLatLng(lat,lng);var html='<div class="bubble"><h3>'+unescape(name)+"</h3><p>"+unescape(content)+"</p></div>";var new_marker=createMarker(point,name,html,colour);map.addOverlay(new_marker);}});};GDownloadUrl("json/vmap-map-loc"+mapLocation+".json?"+datetime,process_it);}function TextualZoomControl(){}TextualZoomControl.prototype=new GControl();TextualZoomControl.prototype.initialize=function(d){var b=document.createElement("div");b.className="controls";var c=document.createElement("div");c.className="zoom zoom-in";b.appendChild(c);c.appendChild(document.createTextNode("Zoom In"));GEvent.addDomListener(c,"click",function(){d.zoomIn();});var a=document.createElement("div");a.className="zoom zoom-out";b.appendChild(a);a.appendChild(document.createTextNode("Zoom Out"));GEvent.addDomListener(a,"click",function(){d.zoomOut();});d.getContainer().appendChild(b);return b;};TextualZoomControl.prototype.getDefaultPosition=function(){return new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(7,7));};TextualZoomControl.prototype.setButtonStyle_=function(a){a.style.textDecoration="underline";a.style.color="#0000cc";a.style.backgroundColor="white";a.style.font="small Arial";a.style.border="1px solid black";a.style.padding="2px";a.style.marginBottom="3px";a.style.textAlign="center";a.style.width="6em";a.style.cursor="pointer";};function setMissionId(){mission_id=document.getElementById("mission").value;GDownloadUrl("json/vmap-map-loc"+mapLocation+".json?"+datetime,process_it);}function focusAgent(){var a=document.getElementById("agent").value;myclick(a);}function removeMarker(){marker.closeInfoWindow();marker.remove();}